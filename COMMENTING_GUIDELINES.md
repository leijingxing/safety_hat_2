# Safety Hat 2 注释规范

## 1. 目标
本规范用于统一项目注释风格，提升以下能力：
- 新成员快速理解关键链路与设计意图。
- 降低误改风险（尤其是 AI 级联、推流、线程相关逻辑）。
- 保持代码可读性，避免“注释噪音”。

## 2. 基本原则
- 注释写“为什么”，不重复“做了什么”。
- 优先解释边界条件、性能取舍、线程模型、协议约束。
- 保持简短：单条注释建议 1-2 行。
- 注释必须与代码同步更新，过期注释等同于错误。
- 默认使用中文；涉及标准术语可中英混写（如 `Annex-B`、`NV21`、`I420`）。

## 3. 应该写注释的场景
- 业务规则不直观：
  - 例如“为什么只取 `person/personup/persondown` 做级联入口”。
- 性能与稳定性相关：
  - 限频、丢帧策略、缓存策略、降级路径。
- 并发/线程切换：
  - 为什么在 `Dispatchers.Default` 执行，为什么不能在主线程执行。
- 协议和数据格式转换：
  - NV21/NV12/I420 转换、RTMP 打包约束、时间戳单位换算。
- 历史兼容或外部依赖约束：
  - JNI 接口不可随意改签名，模型标签映射需多处同步。

## 4. 不应该写注释的场景
- 逐行翻译代码：
  - 例如 `i++`、`setText()` 这类显而易见逻辑。
- 无信息量注释：
  - “初始化变量”“调用方法”。
- 与代码矛盾或可能频繁过期的描述。
- 大段注释掉的废弃代码（请直接删除，必要时看 Git 历史）。

## 5. 注释位置与格式
- 行上方注释优先，避免行尾长注释影响阅读。
- 统一使用 `//` 单行注释。
- 文件头仅在“该文件承担特殊职责”时写 2-4 行说明。
- TODO/FIXME 规范：
  - `TODO(姓名/日期): 说明待办原因和触发条件`
  - `FIXME(姓名/日期): 说明当前缺陷与风险`

示例：
```kotlin
// 使用时间戳做模型限频，避免每帧都跑完整级联导致 CPU 持续满载。
if (!shouldRun(smokeLastMs, pts, 200)) return
```

## 6. 分层注释建议

### 6.1 UI（Compose）
- 说明交互意图与状态来源，不描述基础布局 API。
- 对动画/提示时序写明触发条件和持续时间。

推荐：
```kotlin
// 告警变化时显示 2 秒高亮，避免界面常驻闪烁。
LaunchedEffect(alertId) { ... }
```

### 6.2 ViewModel
- 说明状态聚合策略、窗口统计口径、事件合并规则。
- 对“只在首次执行”的逻辑写清用途（如首帧回填分辨率）。

### 6.3 Repository / UseCase
- 重点描述业务编排顺序、输入输出契约、降级分支。
- AI 级联必须解释“入口条件 + 裁剪策略 + 限频策略”。

### 6.4 RTMP / 编解码
- 明确写出时间单位、颜色格式、丢帧策略、编码器选择策略。
- 涉及 Native 调用顺序的地方必须注释依赖关系。

### 6.5 JNI / Native 边界
- 注释参数语义、生命周期、线程约束。
- 标记“不可变更接口”的原因（兼容现有 so 或上层调用）。

## 7. 示例对照

不推荐：
```kotlin
// 设置 running 为 true
running.set(true)
```

推荐：
```kotlin
// 推流状态只在 RTMP open 成功后置为 true，避免上层误判已连接。
running.set(true)
```

不推荐：
```kotlin
// 循环数组
for (item in items) { ... }
```

推荐：
```kotlin
// 违规列表最多展示 8 条，防止 HUD 在高频告警下挤占预览区域。
items.take(8).forEach { ... }
```

## 8. 注释审查清单（PR 自检）
- 注释是否解释了“为什么”而不是“做什么”？
- 是否覆盖了线程、性能、协议、边界条件？
- 是否与当前实现一致？
- 是否存在可删除的噪音注释？
- 关键链路改动时，相关注释是否同步更新？

## 9. 与本项目强相关的必注释点
- `NcnnCascadeAiRepository`：
  - 人员过滤条件、框扩张比例、模型限频阈值。
- `HudViewModel`：
  - 违规统计时间窗规则、事件合并规则。
- `RtmpStreamer`：
  - 编码格式协商、队列溢出策略、时间戳换算、Native 调用顺序。

